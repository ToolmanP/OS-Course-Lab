/*
 * Copyright (c) 2023 Institute of Parallel And Distributed Systems (IPADS), Shanghai Jiao Tong University (SJTU)
 * Licensed under the Mulan PSL v2.
 * You can use this software according to the terms and conditions of the Mulan PSL v2.
 * You may obtain a copy of Mulan PSL v2 at:
 *     http://license.coscl.org.cn/MulanPSL2
 * THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT, MERCHANTABILITY OR FIT FOR A PARTICULAR
 * PURPOSE.
 * See the Mulan PSL v2 for more details.
 */

#include <dev_messenger.h>
#include <chcore-internal/usb_devmgr_defs.h>
#include <stdio.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <assert.h>
#include <time.h>
#include <unistd.h>

char back[] = {0xff, 0xfe, 0x30, 0x00, 0xcf, 0x65, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x00, 0x00, 0xe0, 0x3f, 0x0,  0x0,  0x0,  0x0,  0x0,
               0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
               0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
               0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
               0x0,  0x0,  0x0,  0x0,  0x0,  0x7b};

char forward[] = {0xff, 0xfe, 0x30, 0x00, 0xcf, 0x65, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0xe0, 0xbf, 0x0,  0x0,  0x0,  0x0,  0x0,
                  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                  0x0,  0x0,  0x0,  0x0,  0x0,  0xfb};

char turn_right[] = {0xff, 0xfe, 0x30, 0x00, 0xcf, 0x65, 0x00, 0x00, 0x00, 0x00,
                     0x00, 0x00, 0x00, 0x00, 0x00, 0x0,  0x0,  0x0,  0x0,  0x0,
                     0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                     0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                     0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                     0x0,  0x0,  0x0,  0xf0, 0xbf, 0xeb};

char turn_left[] = {0xff, 0xfe, 0x30, 0x00, 0xcf, 0x65, 0x00, 0x00, 0x00, 0x00,
                    0x00, 0x00, 0x00, 0x00, 0x00, 0x0,  0x0,  0x0,  0x0,  0x0,
                    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                    0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,  0x0,
                    0x0,  0x0,  0x0,  0xf0, 0x3f, 0x6b};

int main()
{
        int devnum;
        int ret;
        struct timespec ts;
        struct dev_desc *dev_desc;

        struct dev_info *dev_info;
        devnum = dm_list_dev(&dev_info);

        for (int i = 0; i < devnum; i++) {
                printf("[Zixuan list device]: devname:%s, dev_class:%d, vendor:%s\n",
                       dev_info[i].devname,
                       dev_info[i].dev_class,
                       dev_info[i].vendor);
        }

        ret = dm_search_device(dev_info, devnum, "CH340-0", SEARCH_DEV_NAME);
        if (ret != 0) {
                printf("No CH340-0 found.\n");
                return 0;
        }

        if ((dev_desc = dm_open("CH340-0", 0)) == NULL) {
                printf("Error occurs when openning device.\n");
                return 0;
        }
        printf("successfully open CH340-0\n");

        ret = dm_ctrl(dev_desc, SERIAL_WRITE, forward, sizeof(forward));
        assert(ret == 0);
        ts.tv_sec = 1;
        ts.tv_nsec = 500UL * 1000 * 1000;
        nanosleep(&ts, NULL);
        ret = dm_ctrl(dev_desc, SERIAL_WRITE, back, sizeof(back));
        assert(ret == 0);
        nanosleep(&ts, NULL);
        ret = dm_ctrl(dev_desc, SERIAL_WRITE, turn_left, sizeof(turn_left));
        assert(ret == 0);
        nanosleep(&ts, NULL);
        ret = dm_ctrl(dev_desc, SERIAL_WRITE, turn_right, sizeof(turn_right));
        assert(ret == 0);
        nanosleep(&ts, NULL);
        dm_close(dev_desc);
        return 0;
}
